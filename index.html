<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Columbia Ferry Departures – Summer 2025</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
html, body {
  margin: 0;
  height: 100%;
}

#map {
  width: 100%;
  height: 100vh;
}

/* Control panel */
#controls {
  position: absolute;
  top: 10px;
  left: 10px;
  background: white;
  padding: 10px;
  max-height: 80vh;
  overflow-y: auto;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  z-index: 1000;
  width: 260px;
}

#controls.hidden {
  display: none;
}

#toggleControls {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 1100;
  background: #007bff;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 14px;
}

.checkbox-list {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid #ddd;
  padding: 6px;
}

@media (max-width: 768px) {
  #controls {
    width: 90%;
    left: 5%;
  }
}
</style>
</head>

<body>

<button id="toggleControls">Show Controls</button>

<div id="controls" class="hidden">
  <h3>Friday Departures</h3>
  <div id="dayList" class="checkbox-list"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map = L.map("map").setView([48.72, -122.55], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap"
}).addTo(map);

// Geofence box (same as your JSON script)
const LAT_MIN = 48.68, LAT_MAX = 48.78;
const LON_MIN = -122.62, LON_MAX = -122.45;

const geofence = L.rectangle([
  [LAT_MIN, LON_MIN],
  [LAT_MAX, LON_MAX]
], { color: "purple", weight: 2, fillOpacity: 0.05 }).addTo(map);

// Layer group
let trackLayer = L.layerGroup().addTo(map);

// Controls toggle
const toggleBtn = document.getElementById("toggleControls");
const controls = document.getElementById("controls");

toggleBtn.onclick = () => {
  controls.classList.toggle("hidden");
  toggleBtn.textContent = controls.classList.contains("hidden")
    ? "Show Controls"
    : "Hide Controls";
};

// Load JSON
fetch("./columbia_tracks_summer_fridays_2025.json")
  .then(res => res.json())
  .then(data => initUI(data));

function initUI(data) {
  const list = document.getElementById("dayList");

  data.days.forEach((day, i) => {
    const label = document.createElement("label");
    label.style.display = "block";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.value = i;

    label.appendChild(cb);
    label.appendChild(document.createTextNode(" " + day.friday_pt.split("T")[0]));

    list.appendChild(label);
  });

  list.addEventListener("change", () => updateMap(data));
}

// Color scale based on time vs 6pm
function timeColor(dateObj) {
  const minutes = dateObj.getHours() * 60 + dateObj.getMinutes();
  const sixPM = 18 * 60;

  if (minutes < sixPM - 15) return "blue";
  if (minutes <= sixPM + 15) return "green";
  return "red";
}

// Filter to only show departure leg (remove morning arrival)
function isDeparturePoint(pt) {
  return pt.sog >= 2; // remove docked & slow drifting
}

function updateMap(data) {
  trackLayer.clearLayers();

  const checked = [...document.querySelectorAll("#dayList input:checked")]
    .map(cb => parseInt(cb.value));

  checked.forEach(idx => {
    const day = data.days[idx];

    day.points
      .filter(isDeparturePoint)
      .forEach(p => {
        const t = new Date(p.t);

        const color = timeColor(t);

        const marker = L.circleMarker([p.lat, p.lon], {
          radius: 4,
          color: color,
          fillOpacity: 0.8
        });

        marker.bindTooltip(
          `<b>${day.friday_pt.split("T")[0]}</b><br>
           Time: ${t.toLocaleTimeString()}<br>
           Speed: ${p.sog.toFixed(1)} kn`,
          { sticky: true }
        );

        marker.addTo(trackLayer);
      });
  });
}
</script>

</body>
</html>
